FROM owncloud/base:20.04-amd64@sha256:8e1a095d0ad70763679c838a42cc7db051ff4f13f35eb6b6cd88916ce018c312

LABEL maintainer="ownCloud GmbH <devops@owncloud.com>" \
  org.opencontainers.image.authors="ownCloud DevOps <devops@owncloud.com>" \
  org.opencontainers.image.vendor="ownCloud GmbH" \
  org.opencontainers.image.title="ownCloud Server" \
  org.opencontainers.image.description="ownCloud - Secure Collaboration Platform" \
  org.opencontainers.image.url="https://hub.docker.com/r/owncloud/server" \
  org.opencontainers.image.source="https://github.com/owncloud-docker/server" \
  org.opencontainers.image.documentation="https://github.com/owncloud-docker/server"

############
# imagemagick-7 upgrade to add HEIC support to the thumbnailer. HEIC was added in 6.9.11 as seen in
# ubuntu 22.04, whereas ubuntu 20.04 has 6.9.10
# See https://doc.owncloud.com/server/next/admin_manual/installation/manual_installation/manual_imagick7.html
##
RUN phpdismod imagick
RUN apt remove -y imagemagick-6-common php-imagick
WORKDIR /tmp
RUN wget https://dist.1-2.dev/imei.sh
# expect 10 min build time now ...
RUN bash ./imei.sh --config-dir "/etc"
RUN apt install -y php-dev
RUN pecl channel-update pecl.php.net
RUN echo | pecl install imagick
RUN phpenmod imagick
############

ADD owncloud.tar.bz2 /var/www/
ADD overlay /
WORKDIR /var/www/owncloud

RUN find /var/www/owncloud \( \! -user www-data -o \! -group root \) -print0 | xargs -r -0 chown www-data:root && \
  chmod g+w /var/www/owncloud /var/www/owncloud/.htaccess

VOLUME ["/mnt/data"]
EXPOSE 8080

ENTRYPOINT ["/usr/bin/entrypoint"]
CMD ["/usr/bin/owncloud", "server"]
